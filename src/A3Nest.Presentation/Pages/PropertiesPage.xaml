<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="A3Nest.Presentation.Pages.PropertiesPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:components="clr-namespace:A3Nest.Presentation.Components"
             xmlns:viewmodels="clr-namespace:A3Nest.Presentation.ViewModels"
             x:DataType="viewmodels:PropertiesViewModel"
             x:Name="PropertiesPageView"
             Title="{Binding Title}">

    <Grid RowDefinitions="Auto,Auto,*" Padding="16" RowSpacing="16">
        
        <!-- Header Section -->
        <StackLayout Grid.Row="0" Spacing="8">
            <Label Text="Properties Management"
                   FontSize="28"
                   FontAttributes="Bold"
                   TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
            <Label Text="Manage your property portfolio"
                   FontSize="16"
                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
        </StackLayout>

        <!-- Search and Filter Section -->
        <Grid Grid.Row="1" RowDefinitions="Auto,Auto" RowSpacing="12">
            
            <!-- Search Bar -->
            <components:SearchBar Grid.Row="0"
                                  SearchText="{Binding SearchText, Mode=TwoWay}"
                                  Placeholder="Search properties by name, address, or description..."
                                  SearchCommand="{Binding SearchCommand}"
                                  ClearCommand="{Binding ClearSearchCommand}"
                                  ShowSearchButton="True" />

            <!-- Filter and Action Bar -->
            <Grid Grid.Row="1" ColumnDefinitions="Auto,Auto,Auto,Auto,*,Auto" ColumnSpacing="12">
                
                <!-- Property Type Filter -->
                <StackLayout Grid.Column="0" Spacing="4">
                    <Label Text="Type" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                    <Picker ItemsSource="{Binding PropertyTypes}"
                            SelectedItem="{Binding SelectedPropertyType, Mode=TwoWay}"
                            WidthRequest="120"
                            FontSize="14" />
                </StackLayout>

                <!-- Sort By Filter -->
                <StackLayout Grid.Column="1" Spacing="4">
                    <Label Text="Sort By" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                    <Picker ItemsSource="{Binding SortOptions}"
                            SelectedItem="{Binding SortBy, Mode=TwoWay}"
                            WidthRequest="120"
                            FontSize="14" />
                </StackLayout>

                <!-- Sort Direction -->
                <StackLayout Grid.Column="2" Spacing="4">
                    <Label Text="Order" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                    <Button Text="{Binding SortAscending, Converter={StaticResource BoolToSortDirectionConverter}}"
                            Command="{Binding Source={x:Reference PropertiesPageView}, Path=ToggleSortDirectionCommand}"
                            BackgroundColor="Transparent"
                            TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                            FontSize="14"
                            WidthRequest="80" />
                </StackLayout>

                <!-- Results Count -->
                <StackLayout Grid.Column="3" Spacing="4" VerticalOptions="End">
                    <Label Text="{Binding FilteredProperties.Count, StringFormat='{0} properties'}"
                           FontSize="14"
                           TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                           VerticalOptions="Center" />
                </StackLayout>

                <!-- Spacer -->
                <BoxView Grid.Column="4" />

                <!-- Add Property Button -->
                <Button Grid.Column="5"
                        Text="Add Property"
                        Command="{Binding AddPropertyCommand}"
                        BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                        TextColor="White"
                        FontSize="14"
                        Padding="16,8"
                        CornerRadius="8" />
            </Grid>
        </Grid>

        <!-- Properties List -->
        <Border Grid.Row="2"
                BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}"
                Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                StrokeThickness="1"
                StrokeShape="RoundRectangle 8">
            
            <CollectionView ItemsSource="{Binding FilteredProperties}"
                            SelectionMode="Single"
                            SelectedItem="{Binding SelectedProperty, Mode=TwoWay}">
                
                <CollectionView.Header>
                    <!-- Header Row -->
                    <Grid BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
                          Padding="16,12"
                          ColumnDefinitions="*,120,100,120,120,100">
                        <Label Grid.Column="0" Text="Property Details" FontAttributes="Bold" FontSize="14" />
                        <Label Grid.Column="1" Text="Type" FontAttributes="Bold" FontSize="14" />
                        <Label Grid.Column="2" Text="Units" FontAttributes="Bold" FontSize="14" />
                        <Label Grid.Column="3" Text="Purchase Date" FontAttributes="Bold" FontSize="14" />
                        <Label Grid.Column="4" Text="Current Value" FontAttributes="Bold" FontSize="14" />
                        <Label Grid.Column="5" Text="Actions" FontAttributes="Bold" FontSize="14" />
                    </Grid>
                </CollectionView.Header>

                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Grid Padding="16,12"
                              ColumnDefinitions="*,120,100,120,120,100"
                              BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}">
                            
                            <Grid.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding Source={x:Reference PropertiesPageView}, Path=BindingContext.ViewPropertyDetailsCommand}"
                                                      CommandParameter="{Binding .}" />
                            </Grid.GestureRecognizers>

                            <!-- Property Details -->
                            <StackLayout Grid.Column="0" Spacing="4">
                                <Label Text="{Binding Name}"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
                                <Label Text="{Binding Address.Street}"
                                       FontSize="14"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                                <Label Text="{Binding Description}"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray500}}"
                                       LineBreakMode="TailTruncation" />
                            </StackLayout>

                            <!-- Property Type -->
                            <Label Grid.Column="1"
                                   Text="{Binding PropertyType}"
                                   FontSize="14"
                                   VerticalOptions="Center"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray700}, Dark={StaticResource Gray300}}" />

                            <!-- Total Units -->
                            <Label Grid.Column="2"
                                   Text="{Binding TotalUnits}"
                                   FontSize="14"
                                   VerticalOptions="Center"
                                   HorizontalOptions="Center"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray700}, Dark={StaticResource Gray300}}" />

                            <!-- Purchase Date -->
                            <Label Grid.Column="3"
                                   Text="{Binding PurchaseDate, StringFormat='{0:MMM dd, yyyy}'}"
                                   FontSize="14"
                                   VerticalOptions="Center"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray700}, Dark={StaticResource Gray300}}" />

                            <!-- Current Value -->
                            <Label Grid.Column="4"
                                   Text="{Binding CurrentValue.Amount, StringFormat='${0:N0}'}"
                                   FontSize="14"
                                   VerticalOptions="Center"
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" />

                            <!-- Actions -->
                            <StackLayout Grid.Column="5" Orientation="Horizontal" Spacing="8" VerticalOptions="Center">
                                <Button Text="Edit"
                                        Command="{Binding Source={x:Reference PropertiesPageView}, Path=BindingContext.EditPropertyCommand}"
                                        CommandParameter="{Binding .}"
                                        BackgroundColor="Transparent"
                                        TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                        FontSize="12"
                                        Padding="8,4" />
                                <Button Text="Delete"
                                        Command="{Binding Source={x:Reference PropertiesPageView}, Path=BindingContext.DeletePropertyCommand}"
                                        CommandParameter="{Binding .}"
                                        BackgroundColor="Transparent"
                                        TextColor="{AppThemeBinding Light={StaticResource Danger}, Dark={StaticResource DangerDark}}"
                                        FontSize="12"
                                        Padding="8,4" />
                            </StackLayout>

                            <!-- Row Separator -->
                            <BoxView Grid.ColumnSpan="6"
                                     HeightRequest="1"
                                     BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}"
                                     VerticalOptions="End" />
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>

                <CollectionView.EmptyView>
                    <StackLayout Padding="40" Spacing="16" VerticalOptions="Center">
                        <Image Source="empty_properties.svg"
                               WidthRequest="120"
                               HeightRequest="120"
                               HorizontalOptions="Center"
                               Opacity="0.5" />
                        <Label Text="No properties found"
                               FontSize="18"
                               FontAttributes="Bold"
                               HorizontalOptions="Center"
                               TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                        <Label Text="Add your first property to get started with property management"
                               FontSize="14"
                               HorizontalOptions="Center"
                               HorizontalTextAlignment="Center"
                               TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray500}}" />
                        <Button Text="Add Property"
                                Command="{Binding AddPropertyCommand}"
                                BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                TextColor="White"
                                FontSize="16"
                                Padding="20,12"
                                CornerRadius="8"
                                HorizontalOptions="Center" />
                    </StackLayout>
                </CollectionView.EmptyView>
            </CollectionView>
        </Border>
    </Grid>

    <!-- Loading Overlay -->
    <Grid IsVisible="{Binding IsLoading}"
          BackgroundColor="Black"
          Opacity="0.5">
        <ActivityIndicator IsRunning="{Binding IsLoading}"
                           Color="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                           VerticalOptions="Center"
                           HorizontalOptions="Center" />
    </Grid>

    <!-- Search Loading Indicator -->
    <Grid IsVisible="{Binding IsSearching}"
          BackgroundColor="Transparent"
          VerticalOptions="Start"
          Margin="16,80,16,0">
        <Border BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}"
                Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                StrokeThickness="1"
                StrokeShape="RoundRectangle 8"
                Padding="16,12">
            <StackLayout Orientation="Horizontal" Spacing="12">
                <ActivityIndicator IsRunning="{Binding IsSearching}"
                                   Color="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                   WidthRequest="20"
                                   HeightRequest="20" />
                <Label Text="Searching properties..."
                       FontSize="14"
                       VerticalOptions="Center"
                       TextColor="{AppThemeBinding Light={StaticResource Gray700}, Dark={StaticResource Gray300}}" />
            </StackLayout>
        </Border>
    </Grid>
</ContentPage>