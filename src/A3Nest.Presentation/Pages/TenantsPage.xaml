<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="A3Nest.Presentation.Pages.TenantsPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:components="clr-namespace:A3Nest.Presentation.Components"
             xmlns:viewmodels="clr-namespace:A3Nest.Presentation.ViewModels"
             x:DataType="viewmodels:TenantsViewModel"
             x:Name="TenantsPageView"
             Title="{Binding Title}">

    <Grid RowDefinitions="Auto,Auto,*" Padding="16" RowSpacing="16">
        
        <!-- Header Section -->
        <StackLayout Grid.Row="0" Spacing="8">
            <Label Text="Tenant Management"
                   FontSize="28"
                   FontAttributes="Bold"
                   TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
            <Label Text="Manage tenant information and relationships"
                   FontSize="16"
                   TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
        </StackLayout>

        <!-- Search and Filter Section -->
        <Grid Grid.Row="1" RowDefinitions="Auto,Auto" RowSpacing="12">
            
            <!-- Search Bar -->
            <components:SearchBar Grid.Row="0"
                                  SearchText="{Binding SearchText, Mode=TwoWay}"
                                  Placeholder="Search tenants by name, email, or phone..."
                                  SearchCommand="{Binding SearchCommand}"
                                  ClearCommand="{Binding ClearSearchCommand}"
                                  ShowSearchButton="True" />

            <!-- Filter and Action Bar -->
            <Grid Grid.Row="1" ColumnDefinitions="Auto,Auto,Auto,Auto,Auto,*,Auto" ColumnSpacing="12">
                
                <!-- Status Filter -->
                <StackLayout Grid.Column="0" Spacing="4">
                    <Label Text="Status" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                    <Picker ItemsSource="{Binding StatusOptions}"
                            SelectedItem="{Binding SelectedStatus, Mode=TwoWay}"
                            WidthRequest="100"
                            FontSize="14" />
                </StackLayout>

                <!-- Sort By Filter -->
                <StackLayout Grid.Column="1" Spacing="4">
                    <Label Text="Sort By" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                    <Picker ItemsSource="{Binding SortOptions}"
                            SelectedItem="{Binding SortBy, Mode=TwoWay}"
                            WidthRequest="120"
                            FontSize="14" />
                </StackLayout>

                <!-- Sort Direction -->
                <StackLayout Grid.Column="2" Spacing="4">
                    <Label Text="Order" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                    <Button Text="{Binding SortAscending, Converter={StaticResource BoolToSortDirectionConverter}}"
                            Command="{Binding Source={x:Reference TenantsPageView}, Path=ToggleSortDirectionCommand}"
                            BackgroundColor="Transparent"
                            TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                            FontSize="14"
                            WidthRequest="80" />
                </StackLayout>

                <!-- Active Only Toggle -->
                <StackLayout Grid.Column="3" Spacing="4">
                    <Label Text="Active Only" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                    <CheckBox IsChecked="{Binding ShowActiveOnly, Mode=TwoWay}"
                              Color="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" />
                </StackLayout>

                <!-- Results Count -->
                <StackLayout Grid.Column="4" Spacing="4" VerticalOptions="End">
                    <Label Text="{Binding FilteredTenants.Count, StringFormat='{0} tenants'}"
                           FontSize="14"
                           TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}"
                           VerticalOptions="Center" />
                </StackLayout>

                <!-- Spacer -->
                <BoxView Grid.Column="5" />

                <!-- Add Tenant Button -->
                <Button Grid.Column="6"
                        Text="Add Tenant"
                        Command="{Binding AddTenantCommand}"
                        BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                        TextColor="White"
                        FontSize="14"
                        Padding="16,8"
                        CornerRadius="8" />
            </Grid>
        </Grid>

        <!-- Tenants List -->
        <Border Grid.Row="2"
                BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}"
                Stroke="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray600}}"
                StrokeThickness="1"
                StrokeShape="RoundRectangle 8">
            
            <CollectionView ItemsSource="{Binding FilteredTenants}"
                            SelectionMode="Single"
                            SelectedItem="{Binding SelectedTenant, Mode=TwoWay}">
                
                <CollectionView.Header>
                    <!-- Header Row -->
                    <Grid BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
                          Padding="16,12"
                          ColumnDefinitions="*,150,120,120,80,140">
                        <Label Grid.Column="0" Text="Tenant Details" FontAttributes="Bold" FontSize="14" />
                        <Label Grid.Column="1" Text="Contact Info" FontAttributes="Bold" FontSize="14" />
                        <Label Grid.Column="2" Text="Date of Birth" FontAttributes="Bold" FontSize="14" />
                        <Label Grid.Column="3" Text="Monthly Income" FontAttributes="Bold" FontSize="14" />
                        <Label Grid.Column="4" Text="Status" FontAttributes="Bold" FontSize="14" />
                        <Label Grid.Column="5" Text="Actions" FontAttributes="Bold" FontSize="14" />
                    </Grid>
                </CollectionView.Header>

                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Grid Padding="16,12"
                              ColumnDefinitions="*,150,120,120,80,140"
                              BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}">
                            
                            <Grid.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding Source={x:Reference TenantsPageView}, Path=BindingContext.ViewTenantDetailsCommand}"
                                                      CommandParameter="{Binding .}" />
                            </Grid.GestureRecognizers>

                            <!-- Tenant Details -->
                            <StackLayout Grid.Column="0" Spacing="4">
                                <Label Text="{Binding FullName}"
                                       FontSize="16"
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray900}, Dark={StaticResource White}}" />
                                <Label Text="{Binding CreatedAt, StringFormat='Member since {0:MMM yyyy}'}"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray500}}" />
                            </StackLayout>

                            <!-- Contact Info -->
                            <StackLayout Grid.Column="1" Spacing="2">
                                <Label Text="{Binding ContactInfo.Email}"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray700}, Dark={StaticResource Gray300}}"
                                       LineBreakMode="TailTruncation" />
                                <Label Text="{Binding ContactInfo.PhoneNumber}"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light={StaticResource Gray700}, Dark={StaticResource Gray300}}" />
                            </StackLayout>

                            <!-- Date of Birth -->
                            <Label Grid.Column="2"
                                   Text="{Binding DateOfBirth, StringFormat='{0:MMM dd, yyyy}'}"
                                   FontSize="14"
                                   VerticalOptions="Center"
                                   TextColor="{AppThemeBinding Light={StaticResource Gray700}, Dark={StaticResource Gray300}}" />

                            <!-- Monthly Income -->
                            <Label Grid.Column="3"
                                   Text="{Binding MonthlyIncome.Amount, StringFormat='${0:N0}'}"
                                   FontSize="14"
                                   VerticalOptions="Center"
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" />

                            <!-- Status -->
                            <Border Grid.Column="4"
                                    BackgroundColor="{Binding IsActive, Converter={StaticResource BoolToStatusBackgroundConverter}}"
                                    StrokeShape="RoundRectangle 12"
                                    Padding="8,4"
                                    VerticalOptions="Center">
                                <Label Text="{Binding IsActive, Converter={StaticResource BoolToActiveStatusConverter}}"
                                       FontSize="12"
                                       FontAttributes="Bold"
                                       TextColor="White"
                                       HorizontalOptions="Center" />
                            </Border>

                            <!-- Actions -->
                            <StackLayout Grid.Column="5" Orientation="Horizontal" Spacing="4" VerticalOptions="Center">
                                <Button Text="Edit"
                                        Command="{Binding Source={x:Reference TenantsPageView}, Path=BindingContext.EditTenantCommand}"
                                        CommandParameter="{Binding .}"
                                        BackgroundColor="Transparent"
                                        TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                        FontSize="12"
                                        Padding="6,4" />
                                <Button Text="Applications"
                                        Command="{Binding Source={x:Reference TenantsPageView}, Path=BindingContext.ViewLeaseApplicationsCommand}"
                                        CommandParameter="{Binding .}"
                                        BackgroundColor="Transparent"
                                        TextColor="{AppThemeBinding Light={StaticResource Secondary}, Dark={StaticResource SecondaryDark}}"
                                        FontSize="12"
                                        Padding="6,4" />
                                <Button Text="{Binding IsActive, Converter={StaticResource BoolToDeactivateTextConverter}}"
                                        Command="{Binding IsActive, Converter={StaticResource BoolToDeactivateCommandConverter}, 
                                                  ConverterParameter={Binding Source={x:Reference TenantsPageView}, Path=BindingContext}}"
                                        CommandParameter="{Binding .}"
                                        BackgroundColor="Transparent"
                                        TextColor="{Binding IsActive, Converter={StaticResource BoolToDeactivateColorConverter}}"
                                        FontSize="12"
                                        Padding="6,4" />
                            </StackLayout>

                            <!-- Row Separator -->
                            <BoxView Grid.ColumnSpan="6"
                                     HeightRequest="1"
                                     BackgroundColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}"
                                     VerticalOptions="End" />
                        </Grid>
                    </DataTemplate>
                </CollectionView.ItemTemplate>

                <CollectionView.EmptyView>
                    <StackLayout Padding="40" Spacing="16" VerticalOptions="Center">
                        <Image Source="empty_tenants.svg"
                               WidthRequest="120"
                               HeightRequest="120"
                               HorizontalOptions="Center"
                               Opacity="0.5" />
                        <Label Text="No tenants found"
                               FontSize="18"
                               FontAttributes="Bold"
                               HorizontalOptions="Center"
                               TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray400}}" />
                        <Label Text="Add your first tenant to start managing tenant relationships"
                               FontSize="14"
                               HorizontalOptions="Center"
                               HorizontalTextAlignment="Center"
                               TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray500}}" />
                        <Button Text="Add Tenant"
                                Command="{Binding AddTenantCommand}"
                                BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                TextColor="White"
                                FontSize="16"
                                Padding="20,12"
                                CornerRadius="8"
                                HorizontalOptions="Center" />
                    </StackLayout>
                </CollectionView.EmptyView>
            </CollectionView>
        </Border>
    </Grid>

    <!-- Loading Overlay -->
    <Grid IsVisible="{Binding IsLoading}"
          BackgroundColor="Black"
          Opacity="0.5">
        <ActivityIndicator IsRunning="{Binding IsLoading}"
                           Color="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                           VerticalOptions="Center"
                           HorizontalOptions="Center" />
    </Grid>

    <!-- Search Loading Indicator -->
    <Grid IsVisible="{Binding IsSearching}"
          BackgroundColor="Transparent"
          VerticalOptions="Start"
          Margin="16,80,16,0">
        <Border BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}"
                Stroke="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray600}}"
                StrokeThickness="1"
                StrokeShape="RoundRectangle 8"
                Padding="16,12">
            <StackLayout Orientation="Horizontal" Spacing="12">
                <ActivityIndicator IsRunning="{Binding IsSearching}"
                                   Color="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                   WidthRequest="20"
                                   HeightRequest="20" />
                <Label Text="Searching tenants..."
                       FontSize="14"
                       VerticalOptions="Center"
                       TextColor="{AppThemeBinding Light={StaticResource Gray700}, Dark={StaticResource Gray300}}" />
            </StackLayout>
        </Border>
    </Grid>
</ContentPage>